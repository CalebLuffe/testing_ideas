---

- hosts: database_servers
  pre_tasks:
  - name: Get disk facts
    win_disk_facts:

  - name: debug stuff
    debug:
      var: ansible_disks[1].partition_count
#      var: ansible_disks[0].size

  - name: Initialize Disk
    win_shell: "Initialize-Disk -Number 1 -PartitionStyle MBR"
    when: ansible_disks[1].partition_count == 0

  - name: Create a partition with drive letter D and max size
    win_partition:
      disk_number: 1
      partition_size: -1
      drive_letter: D
    when: ansible_disks[1].partition_count == 0

  - name: Full format the newly created partition as NTFS and label it
    win_format:
      drive_letter: D
      file_system: NTFS
      new_label: Formatted
      full: false
    when: ansible_disks[1].partition_count == 0

  - name: create Temp folder
    win_file:
      path: C:\Temp
      state: directory

  - name: Download WMF5 MSU
    win_get_url:
      url: https://go.microsoft.com/fwlink/?linkid=839516
      dest: C:\Temp\Win8.1AndW2K12R2-KB3191564-x64.msu

  - name: Extract PS5 MSU
    win_shell: start-process wusa.exe -Argumentlist "C:\Temp\Win8.1AndW2K12R2-KB3191564-x64.msu /extract:C:\Temp"

  - name: Install PS5 Cab file
    win_shell: dism.exe /Quiet /online /add-package /norestart /Packagepath:C:\Temp\WindowsBlue-KB3191564-x64.cab
    ignore_errors: true

  roles:
  - ad_joined
  - common
  - sqlserver

#TODO get the localhost meta mof to setup LCM from a kenzo location
# "New-Item -Path 'C:\\DSCSMB' -Type directory -Force",
# "Copy-Item –Path '\\\\kenzoserver\\Software\\kenzo\\DSCSMB\\localhost.meta.mof' –Destination 'C:\\DSCSMB\\'",
# "Set-DscLocalConfigurationManager -Verbose -ComputerName localhost –Path 'C:\\DSCSMB\\'",
